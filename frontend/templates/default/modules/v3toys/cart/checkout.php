<?php/** * @author Semenov Alexander <semenov@skeeks.com> * @link http://skeeks.com/ * @copyright 2010 SkeekS (СкикС) * @date 22.09.2015 *//* @var $this yii\web\View *//* @var $model \v3toys\skeeks\models\V3toysOrder */?><?\frontend\assets\CartAsset::register($this);\skeeks\cms\shop\widgets\ShopGlobalWidget::widget();?><?$json = \yii\helpers\Json::encode([    'getPrices' => \yii\helpers\Url::to(['/v3toys/cart/get-prices']),    'save' => \yii\helpers\Url::to(['/v3toys/cart/save-session']),]);$this->registerJs(<<<JS(function(sx, $, _){    sx.classes.Checkout = sx.classes.Component.extend({        _onDomReady: function()        {            var self = this;            this.JForm = $('#sx-checkout');            $('.sx-deliveryChange, #v3toysorder-pickup_point_id', this.JForm).on('change', function()            {                self.updatePrices();            });            $('select, input, textarea', this.JForm).on('change', function()            {                self.save();            });        },        save: function()        {            var self = this;            var ajaxQuery = sx.ajax.preparePostQuery(this.get('save'), self.JForm.serialize());            ajaxQuery.execute();            return this;        },        updatePrices: function()        {            var self = this;            this.ajaxQuery = sx.ajax.preparePostQuery(this.get('getPrices'), self.JForm.serialize());            this.ajaxQuery.bind('success', function(e, data)            {                var result = data.response.data;                $('.sx-money').empty().append(result.money.convertAndFormat);                $('.sx-moneyDiscount').empty().append(result.moneyDiscount.convertAndFormat);                $('.sx-moneyDelivery').empty().append(result.moneyDelivery.convertAndFormat);                $('.sx-moneyOriginal').empty().append(result.moneyOriginal.convertAndFormat);            });            this.ajaxQuery.execute();        }    });    sx.Checkout = new sx.classes.Checkout({$json});})(sx, sx.$, sx._);JS);?>    <? if (!\Yii::$app->shop->shopFuser->isEmpty()) : ?>        <hr />            <div class="row">                <div class="col-lg-12">                <?php $form = \skeeks\cms\base\widgets\ActiveFormAjaxSubmit::begin([                    'validationUrl'  => \yii\helpers\Url::to('/v3toys/cart/checkout-validate'),                    'id'  => 'sx-checkout',                    'enableClientValidation' => false,                    'enableAjaxValidation' => true,                    'options'                                 => [                        'class' => 'form-box form-horizontal'                    ],                    'afterValidateCallback'                     => new \yii\web\JsExpression(<<<JS                        function(jForm, ajax)                        {                            var handler = new sx.classes.AjaxHandlerStandartRespose(ajax, {                                'blockerSelector' : '#' + jForm.attr('id'),                                'enableBlocker' : true,                            });                            handler.bind('error', function(e, data)                            {                                $('.sx-success-message', jForm).hide();                                $('.sx-error-message', jForm).show();                                $('.sx-error-message .sx-body', jForm).empty().append(data.message);                            });                            handler.bind('success', function(e, data)                            {                                $('.sx-error-message', jForm).hide();                                $('.sx-success-message', jForm).show();                                $('.sx-success-message .sx-body', jForm).empty().append(data.message);                                $('input, textarea', jForm).each(function(value, key)                                {                                    var name = $(this).attr('name');                                    if (name != '_csrf' && name != 'sx-model-value' && name != 'sx-model')                                    {                                        $(this).val('');                                    }                                });                                $('.sx-btn-order-result').empty().text('Принято!');                                _.delay(function()                                {                                    //$.fancybox.close();                                    //window.location.reload();                                    $('.modal-close', jForm).click();                                }, 3000);                            });                        }JS                ),                ]);                ?>                        <?= $form->field($model, 'name', [                            'template'      => "{label}\n<div class='col-md-6'><div class='form-control-wrapper'>{input}{hint}{error}</div></div>",                            'labelOptions'  => ['class' => 'col-md-2 control-label'],                            'errorOptions'  => ['class' => 'error-tooltip'],                        ])->label('Контактное лицо')->textInput(['placeholder' => $model->getAttributeLabel('name')]); ?>                        <?= $form->field($model, 'phone', [                            'template'      => "<div class='col-md-3 col-md-offset-2'><div class='form-control-wrapper'>{input}{hint}{error}</div></div>",                            'labelOptions'  => ['class' => 'col-md-2 control-label'],                            'errorOptions'  => ['class' => 'error-tooltip'],                        ])->label(false)->textInput([                            'class' => 'form-control input-mask-phone-placeholder',                            'placeholder' => $model->getAttributeLabel('phone'),                            'type' => 'tel'                        ]); ?>                        <?= $form->field($model, 'email', [                            'template'      => "<div class='col-md-6 col-md-offset-2'><div class='form-control-wrapper'>{input}{hint}{error}</div></div>",                            'labelOptions'  => ['class' => 'col-md-2 control-label'],                            'errorOptions'  => ['class' => 'error-tooltip'],                        ])->label(false)->textInput([                            'placeholder' => $model->getAttributeLabel('email'),                            'type' => 'email'                        ]); ?><div class="row">    <div class="col-lg-12">           <?    $radioElement = new \v3toys\skeeks\widgets\delivery\V3toysDeliveryInputWidget([        'model' => $model,        'attribute' => 'shipping_method',        'options' => [            'class' => 'sx-deliveryChange'        ],    ]);    $radioElement = $radioElement->run();    $controller = $this->context;    $region = \Yii::$app->dadataSuggest->address ? \Yii::$app->dadataSuggest->address->regionString : "Выбрать город";    ?>        <?= \v3toys\skeeks\widgets\delivery\V3toysDeliveryWidget::widget([                'contentSelectRegion' => <<<HTML<div class="city">    <span class="lbl">Выберите способ доставки в </span>    <span class="link"><a href="#" onclick="new sx.classes.ModalRegionPjaxReload({        'id' : 'sx-cart-full'    }); return false;" >        {$region}    </a></span></div>HTML,                'contentPost' => $this->render('_post', [                    'form' => $form,                    'model' => $model,                ]),                'contentPickup' => $this->render('_pickup', [                                    'form' => $form,                                    'model' => $model,                ]),                'contentCourier' => $this->render('_courier', [                                    'form' => $form,                                    'model' => $model,                ]),                'contentRadioElement' => $radioElement,        ]); ?></div></div>                        <?= $form->field($model, 'comment', [                            'template'      => "{label}\n<div class='col-md-6'><div class='form-control-wrapper'>{input}{hint}{error}</div></div>",                            'labelOptions'  => ['class' => 'col-md-2 control-label'],                            'errorOptions'  => ['class' => 'error-tooltip'],                        ])->textarea([                            'placeholder' => 'У вас есть пожелания к заказу?',                            'rows' => 7                        ]); ?>                        <!--<div class="form-group">                            <label class="col-md-2 control-label">Оплата</label>                            <div class="col-md-6">                                <select class="bootstrap-select">                                    <option selected>Наличными при получении заказа</option>                                </select>                            </div>                        </div>-->                        <!--<hr/>-->                        <?/*= $form->field($model, 'is_call_me_15_min', [                            'template'      => "<div class='col-md-6 col-md-offset-2'><div class='checkbox agree-subscribe'>{input}{hint}{error}</div></div>",                            'labelOptions'  => ['class' => 'col-md-2 control-label'],                            'errorOptions'  => ['class' => 'error-tooltip'],                        ])->checkbox(\Yii::$app->formatter->booleanFormat); */?>                        <!--<div class="form-group">                            <div class="col-md-6 col-md-offset-2">                                <div class="checkbox agree-subscribe">                                    <input type="checkbox" id="ready-call" checked/>                                    <label for="ready-call">Готов принять звонок в течении 15 минут</label>                                </div>                            </div>                        </div>-->                        <hr/>                        <div class="form-group">                            <div class="col-md-6 col-md-offset-2">                                <div class="tbl cart-info cart-info-free">                                    <?= $this->render("@app/views/modules/shop/cart/_result", [                                        'model' => $model                                    ]); ?>                                    <!--<div class="tbl-row">                                        <div class="tbl-cell tbl-cell-lbl">Сумма заказа</div>                                        <div class="tbl-cell tbl-cell-val">4 290 <span class="rub">"</span></div>                                    </div>                                    <div class="tbl-row">                                        <div class="tbl-cell tbl-cell-lbl">Акция</div>                                        <div class="tbl-cell tbl-cell-val">-290 <span class="rub">"</span></div>                                    </div>                                    <div class="tbl-row">                                        <div class="tbl-cell tbl-cell-lbl">Доставка</div>                                        <div class="tbl-cell tbl-cell-val">150 <span class="rub">"</span></div>                                    </div>                                    <div class="tbl-row">                                        <div class="tbl-cell tbl-cell-lbl total">Итого:</div>                                        <div class="tbl-cell tbl-cell-val total">4 290 <span class="rub">"</span></div>                                    </div>-->                                </div>                            </div>                        </div>                        <hr/>                        <div class="row">                            <?= \yii\bootstrap\Alert::widget([                                'options' => [                                    'class' => 'alert-success sx-form-message sx-success-message',                                    'style' => 'display: none;',                                ],                                'closeButton' => false,                                'body' => '<div class="sx-body">Ok</div>',                            ])?>                            <?= \yii\bootstrap\Alert::widget([                                'options' => [                                    'class' => 'alert-danger sx-form-message sx-error-message',                                    'style' => 'display: none;',                                ],                                'closeButton' => false,                                'body' => '<div class="sx-body">Ok</div>',                            ])?>                        </div>                        <div class="row">                            <div class="col-md-6 col-md-offset-2 form-box-submit">                                <button type="submit" class="btn">Подтвердить заказ</button>                            </div>                        </div>                    <? $form::end(); ?>                </div>        </div>    <? endif; ?>